generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Audit {
  id                 String        @id @default(cuid())
  status             AuditStatus   @default(PENDING)
  siteUrl            String
  productDesc        String?
  competitors        String[]
  sections           String[]
  email              String
  pagesFound         Int?
  sitemapUrlCount    Int?
  hasRobotsTxt       Boolean?
  hasSitemap         Boolean?
  opportunities      Json?
  detectedSections   Json?
  healthScore        Json?
  redirectChains     Json?
  progress           Json?
  retryAfter         DateTime?
  delayEmailSentAt   DateTime?
  supportAlertSentAt DateTime?
  apiUsage           Json?
  stripeSessionId    String?       @unique
  lsOrderId          String?
  tier               AuditTier
  accessToken        String        @unique
  expiresAt          DateTime
  reportEmailSentAt  DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  startedAt          DateTime?
  completedAt        DateTime?
  targetKeywords     String[]
  pipelineState      Json?
  isNewSite          Boolean       @default(false)

  // New simplified flow columns
  crawlComplete         Boolean       @default(false)
  suggestedCompetitors  Json?
  selectedCompetitors   String[]      @default([])
  suggestedClusters     Json?
  selectedClusters      String[]      @default([])
  prefetchedRankings Json?
  briefs             Brief[]
  crawledPages       CrawledPage[]
}

model Brief {
  id                     String   @id @default(cuid())
  auditId                String
  keyword                String
  searchVolume           Int
  difficulty             Int
  title                  String
  structure              Json
  questions              String[]
  relatedKw              String[]
  competitors            Json?
  suggestedInternalLinks String[]
  clusteredKeywords      String[] @default([])
  totalClusterVolume     Int      @default(0)
  estimatedEffort        String?
  intent                 String?
  createdAt              DateTime @default(now())
  audit                  Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
}

model CrawledPage {
  id               String   @id @default(cuid())
  auditId          String
  url              String
  title            String?
  h1               String?
  content          String?
  wordCount        Int?
  section          String?
  outboundLinks    String[]
  readabilityScore Float?
  codeBlockCount   Int      @default(0)
  imageCount       Int      @default(0)
  codeBlocks       String[]
  metaDescription  String?
  canonicalUrl     String?
  ogTitle          String?
  ogDescription    String?
  ogImage          String?
  h1Count          Int      @default(1)
  h2s              String[]
  h3s              String[]
  imagesWithoutAlt Int      @default(0)
  hasSchemaOrg     Boolean  @default(false)
  schemaTypes      String[]
  hasViewport      Boolean  @default(false)
  createdAt        DateTime @default(now())
  coreWebVitals    Json?
  audit            Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
}

model User {
  id               String    @id
  name             String
  email            String    @unique
  emailVerified    Boolean   @default(false)
  image            String?
  role             String    @default("user")
  twoFactorEnabled Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  accounts         Account[]
  sessions         Session[]

  @@map("user")
}

model Session {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model TwoFactor {
  id          String @id
  userId      String
  secret      String
  backupCodes String

  @@map("twoFactor")
}

enum AuditStatus {
  PENDING
  CRAWLING
  SELECTING_COMPETITORS
  SELECTING_TOPICS
  ANALYZING
  GENERATING_BRIEFS // Legacy - kept for existing audits
  RETRYING          // Legacy - kept for existing audits
  COMPLETED
  FAILED
}

enum AuditTier {
  FREE
  SCAN
  AUDIT
  DEEP_DIVE
}
