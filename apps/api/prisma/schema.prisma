generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Audit {
  id          String      @id @default(cuid())
  status      AuditStatus @default(PENDING)
  siteUrl     String
  productDesc String?
  competitors String[]
  sections    String[]
  email       String

  pagesFound       Int?
  sitemapUrlCount  Int?
  hasRobotsTxt     Boolean?
  hasSitemap       Boolean?
  opportunities    Json?
  detectedSections Json?
  healthScore      Json?
  redirectChains   Json?

  // Resilient pipeline: component-level progress tracking
  progress           Json?      // AuditProgress object tracking each component's status
  retryAfter         DateTime?  // When to retry failed components
  delayEmailSentAt   DateTime?  // When we sent "taking longer" notification
  supportAlertSentAt DateTime?  // When we alerted support about struggling audit

  // API usage tracking
  apiUsage Json? // ApiUsage object for cost monitoring

  stripeSessionId  String?   @unique
  lsOrderId        String?   // LemonSqueezy order ID for refunds
  tier             AuditTier
  accessToken      String    @unique
  expiresAt        DateTime
  reportEmailSentAt DateTime? // When report email was successfully sent

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?  // When processing actually began
  completedAt DateTime?

  briefs       Brief[]
  crawledPages CrawledPage[]
}

model Brief {
  id      String @id @default(cuid())
  auditId String
  audit   Audit  @relation(fields: [auditId], references: [id], onDelete: Cascade)

  keyword                String
  searchVolume           Int
  difficulty             Int
  title                  String
  structure              Json
  questions              String[]
  relatedKw              String[]
  competitors            Json?
  suggestedInternalLinks String[]
  clusteredKeywords      String[] @default([])
  totalClusterVolume     Int      @default(0)
  estimatedEffort        String?
  intent                 String?

  createdAt DateTime @default(now())

  @@index([auditId])
}

model CrawledPage {
  id      String @id @default(cuid())
  auditId String
  audit   Audit  @relation(fields: [auditId], references: [id], onDelete: Cascade)

  url              String
  title            String?
  h1               String?
  content          String?
  wordCount        Int?
  section          String?
  outboundLinks    String[]
  readabilityScore Float?
  codeBlockCount   Int      @default(0)
  imageCount       Int      @default(0)
  codeBlocks       String[]

  // SEO meta fields
  metaDescription  String?
  canonicalUrl     String?
  ogTitle          String?
  ogDescription    String?
  ogImage          String?
  h1Count          Int      @default(1)
  h2s              String[]
  h3s              String[]
  imagesWithoutAlt Int      @default(0)
  hasSchemaOrg     Boolean  @default(false)
  schemaTypes      String[]
  hasViewport      Boolean  @default(false)

  // Core Web Vitals (PageSpeed Insights)
  coreWebVitals Json?

  createdAt DateTime @default(now())

  @@index([auditId])
}

enum AuditStatus {
  PENDING
  CRAWLING
  ANALYZING
  GENERATING_BRIEFS
  RETRYING           // Waiting for background retry of failed components
  COMPLETED
  FAILED
}

enum AuditTier {
  FREE
  SCAN
  AUDIT
  DEEP_DIVE
}

// Better Auth tables
model User {
  id               String    @id
  name             String
  email            String    @unique
  emailVerified    Boolean   @default(false)
  image            String?
  role             String    @default("user")
  twoFactorEnabled Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  sessions         Session[]
  accounts         Account[]

  @@map("user")
}

model Session {
  id        String   @id
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("session")
}

model Account {
  id                    String    @id
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model TwoFactor {
  id        String @id
  userId    String
  secret    String
  backupCodes String

  @@map("twoFactor")
}
